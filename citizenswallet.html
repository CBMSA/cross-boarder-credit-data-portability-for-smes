

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sadicoin Wallet (Prototype with FX + Transactions + MoonPay API)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f6f9fc; margin: 0; padding: 20px; }
    h1 { color: #2a4d8f; }
    .box { background: #fff; padding: 20px; margin: 15px auto; max-width: 600px; border-radius: 10px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
    input, button, select { width: 100%; margin: 6px 0; padding: 10px; font-size: 14px; }
    button { background: #2a4d8f; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #1c3360; }
    pre { background: #eef6ff; padding: 10px; border-radius: 6px; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f4f9; }
  </style>
</head>
<body>
  <h1>ðŸ’³ Sadicoin Wallet Prototype</h1>

  <!-- Register -->
  <div class="box">
    <h3>Register</h3>
    <input id="r_name" placeholder="Name">
    <input id="r_email" placeholder="Email">
    <input id="r_phone" placeholder="Phone">
    <input id="r_pass" placeholder="Password" type="password">
    <button onclick="register()">Register (Get USD 200)</button>
  </div>

  <!-- Login -->
  <div class="box">
    <h3>Login</h3>
    <input id="l_email" placeholder="Email">
    <input id="l_pass" placeholder="Password" type="password">
    <button onclick="login()">Login</button>
  </div>

  <!-- Wallet -->
  <div class="box">
    <h3>Wallet</h3>
    <label>Show balance in:</label>
    <select id="fx_currency" onchange="refreshWallet()"></select>
    <pre id="wallet_info">Not logged in</pre>
    <button onclick="refreshWallet()">Refresh</button>
  </div>

  <!-- Send -->
  <div class="box">
    <h3>Send USD</h3>
    <input id="to_addr" placeholder="Recipient address">
    <input id="to_amt" placeholder="Amount (USD)" type="number">
    <button onclick="send()">Send</button>
    <pre id="send_res"></pre>
  </div>

  <!-- Transactions -->
  <div class="box">
    <h3>Transaction History</h3>
    <table id="tx_table">
      <thead><tr><th>ID</th><th>To</th><th>Amount</th><th>Date</th><th>PDF</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- MoonPay Swap -->
  <div class="box">
    <h3>MoonPay Swap</h3>
    <button onclick="openSwap()">Swap with MoonPay</button>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const USERS_KEY = "sadi_users";
    const TXS_KEY = "sadi_txs";
    let currentUser = null;

    const currencySymbols = ["USD","ZAR","BWP","MZN","XDR","XAU"];
    const eodhdToken = "67b2d451e5b8a8.90504186";
    let fxRates = {};

    // --- Persistence helpers ---
    function getUsers(){ return JSON.parse(localStorage.getItem(USERS_KEY)||"{}"); }
    function saveUsers(u){ localStorage.setItem(USERS_KEY, JSON.stringify(u)); }
    function getTxs(){ return JSON.parse(localStorage.getItem(TXS_KEY)||"[]"); }
    function saveTxs(t){ localStorage.setItem(TXS_KEY, JSON.stringify(t)); }

    // --- Register ---
    function register(){
      const name=r_name.value,email=r_email.value,phone=r_phone.value,password=r_pass.value;
      if(!name||!email||!phone||!password) return alert("Fill all fields");
      let u=getUsers();
      if(u[email]) return alert("User exists!");
      const wallet={ address:"0x"+Math.random().toString(16).substr(2,40), balance:200 }; // USD 200
      u[email]={name,email,phone,password,wallet};
      saveUsers(u);
      alert("Registered! You got USD 200.");
    }

    // --- Login ---
    function login(){
      const email=l_email.value,password=l_pass.value;
      let u=getUsers();
      if(!u[email]||u[email].password!==password) return alert("Invalid credentials");
      currentUser=email;
      refreshWallet();
      refreshTxTable();
    }

    // --- FX Rates ---
    async function loadRates(){
      try{
        const resp=await fetch(
          `https://eodhd.com/api/real-time/USDZAR.FOREX,USDBWP.FOREX,USDMZN.FOREX,USDXDR.FOREX,USDXAU.FOREX?api_token=${eodhdToken}&fmt=json`
        );
        const data=await resp.json();
        fxRates={USD:1};
        data.forEach(it=>{
          if(it.code.startsWith("USD")){
            const cur=it.code.replace("USD","").replace(".FOREX","");
            fxRates[cur]=it.close;
          }
        });
      }catch(e){
        console.warn("FX API failed",e);
        fxRates={USD:1,ZAR:19,BWP:13,MZN:63,XDR:0.72,XAU:0.00057};
      }
      const sel=document.getElementById("fx_currency");
      sel.innerHTML=currencySymbols.map(c=>
        `<option value="${c}">${c} (${fxRates[c]||'n/a'})</option>`
      ).join("");
      refreshWallet();
    }

    // --- Wallet ---
    function refreshWallet(){
      if(!currentUser) return wallet_info.innerText="Not logged in";
      let u=getUsers()[currentUser];
      let balanceUSD=u.wallet.balance.toFixed(2);
      let cur=document.getElementById("fx_currency").value||"ZAR";
      let rate=fxRates[cur]||0;
      let balanceLocal=rate?(u.wallet.balance*rate).toFixed(2):"n/a";
      wallet_info.innerText=`Address: ${u.wallet.address}\nBalance: USD ${balanceUSD}\n${cur} â‰ˆ ${balanceLocal}`;
    }

    // --- Send ---
    function send(){
      if(!currentUser) return alert("Login first");
      const to=to_addr.value, amt=parseFloat(to_amt.value);
      if(!to||isNaN(amt)) return alert("Fill fields");
      let u=getUsers();
      let me=u[currentUser];
      if(me.wallet.balance<amt) return alert("Insufficient funds");
      me.wallet.balance-=amt;
      saveUsers(u);

      // transaction record
      const txId="TX"+Date.now();
      let tx={id:txId,from:me.wallet.address,to,amount:amt,date:new Date().toLocaleString()};
      let txs=getTxs(); txs.push(tx); saveTxs(txs);

      send_res.innerText=`Sent USD ${amt.toFixed(2)} to ${to}\nTxID: ${txId}`;
      refreshWallet();
      refreshTxTable();
      generatePDF(tx);
    }

    // --- Transactions ---
    function refreshTxTable(){
      let txs=getTxs();
      let body=document.querySelector("#tx_table tbody");
      body.innerHTML=txs.map(t=>
        `<tr><td>${t.id}</td><td>${t.to}</td><td>USD ${t.amount}</td><td>${t.date}</td><td><button onclick="generatePDF(${JSON.stringify(t).replace(/"/g,'&quot;')})">PDF</button></td></tr>`
      ).join("");
    }

    // --- PDF ---
    function generatePDF(tx){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text("Sadicoin Transaction Receipt",20,20);
      doc.text(`TxID: ${tx.id}`,20,40);
      doc.text(`From: ${tx.from}`,20,50);
      doc.text(`To: ${tx.to}`,20,60);
      doc.text(`Amount: USD ${tx.amount}`,20,70);
      doc.text(`Date: ${tx.date}`,20,80);
      doc.save(`${tx.id}.pdf`);
    }

    // --- MoonPay with Backend-assisted flow + Fallback ---
    async function openSwap(){
      if(!currentUser) return alert("Login first");
      let u=getUsers()[currentUser];
      try {
        // Try backend-assisted flow
        const resWallet = await fetch(`/api/wallet/${encodeURIComponent(currentUser)}`);
        if (!resWallet.ok) throw new Error("Backend wallet not available");
        const wallet = await resWallet.json();

        const res = await fetch(`/api/moonpay-url?currency=usd&address=${encodeURIComponent(wallet.address)}`);
        if (!res.ok) throw new Error("Backend MoonPay not available");
        const data = await res.json();

        window.open(data.url, "_blank");
      } catch (err) {
        console.warn("Backend MoonPay failed, falling back:", err);
        // Fallback: direct frontend link
        const usd=u.wallet.balance.toFixed(2);
        const url=`https://buy.moonpay.com?apiKey=pk_live_0UYBzlsyM4A3Adj47IQrOkRx6dCWB4k&currencyCode=usd&walletAddress=${u.wallet.address}&baseCurrencyAmount=${usd}`;
        window.open(url,"_blank");
      }
    }

    // Init
    loadRates();
    setInterval(loadRates,1000*60*5);
  </script>
</body>
</html>



