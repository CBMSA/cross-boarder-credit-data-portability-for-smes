<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sadicoin Wallet (SADI)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:sans-serif;margin:20px;background:#f9fafb;color:#333;}
    h1{text-align:center;color:#0055aa;}
    .box{background:#fff;border:1px solid #ddd;padding:20px;border-radius:12px;margin:20px auto;max-width:480px;}
    input{width:100%;padding:10px;margin:6px 0;border:1px solid #bbb;border-radius:8px;}
    button{background:#0055aa;color:#fff;border:none;border-radius:8px;padding:12px;width:100%;cursor:pointer;}
    button:hover{background:#003f7f;}
    #wallet_info,#send_res{background:#eef6ff;border:1px solid #bbe0ff;padding:12px;border-radius:8px;margin-top:10px;}
  </style>
</head>
<body>
  <h1>Sadicoin Wallet (SADI)</h1>

  <div class="box">
    <h3>Register</h3>
    <input id="r_name" placeholder="Full name">
    <input id="r_email" placeholder="Email">
    <input id="r_phone" placeholder="Phone">
    <input id="r_pass" placeholder="Password" type="password">
    <button onclick="register()">Register (airdrop 100 SADI)</button>
  </div>

  <div class="box">
    <h3>Login</h3>
    <input id="l_email" placeholder="Email">
    <input id="l_pass" placeholder="Password" type="password">
    <button onclick="login()">Login</button>
  </div>

  <div class="box">
    <h3>Wallet</h3>
    <div id="wallet_info">Not logged in</div>
    <button onclick="loadWallet()">Refresh Wallet</button>
  </div>

  <div class="box">
    <h3>Send SADI</h3>
    <input id="to_addr" placeholder="Recipient EVM address (0x...)">
    <input id="to_amt" placeholder="Amount (SADI)" type="number">
    <button onclick="send()">Send</button>
    <div id="send_res"></div>
  </div>

  <div class="box">
    <h3>Swap via MoonPay</h3>
    <button onclick="openSwap()">Swap Now</button>
  </div>

  <script>
    let currentUser = null;

    async function register() {
      const body = {
        name: document.getElementById("r_name").value,
        email: document.getElementById("r_email").value,
        phone: document.getElementById("r_phone").value,
        password: document.getElementById("r_pass").value,
      };
      const res = await fetch("/api/register", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) return alert(data.error);
      currentUser = body.email;
      alert("Registered! Wallet created.");
      loadWallet();
    }

    async function login() {
      const body = {
        email: document.getElementById("l_email").value,
        password: document.getElementById("l_pass").value,
      };
      const res = await fetch("/api/login", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) return alert(data.error);
      currentUser = body.email;
      alert("Login successful.");
      loadWallet();
    }

    async function loadWallet() {
      if (!currentUser) return document.getElementById("wallet_info").innerText = "Not logged in";
      const res = await fetch(`/api/wallet/${currentUser}`);
      const wallet = await res.json();
      if (wallet.error) return alert(wallet.error);
      document.getElementById("wallet_info").innerText =
        `Address: ${wallet.address}\nBalance: ${wallet.balance.toFixed(6)} SADI`;
    }

    async function send() {
      if (!currentUser) return alert("Login first.");
      const body = {
        fromEmail: currentUser,
        toAddr: document.getElementById("to_addr").value,
        amount: parseFloat(document.getElementById("to_amt").value),
      };
      const res = await fetch("/api/send", {
        method: "POST", headers: {"Content-Type": "application/json"},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      document.getElementById("send_res").innerText = data.error || data.message;
      loadWallet();
    }

    async function openSwap() {
      if (!currentUser) return alert("Login first.");
      const resWallet = await fetch(`/api/wallet/${currentUser}`);
      const wallet = await resWallet.json();
      const res = await fetch(`/api/moonpay-url?currency=eth&address=${wallet.address}`);
      const data = await res.json();
      window.open(data.url, "_blank");
    }
  </script>
</body>
</html>
