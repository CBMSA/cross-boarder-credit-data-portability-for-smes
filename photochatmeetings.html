<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SadiCoin Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#0b0b0b; color:#fff; }
    button { padding:10px; margin:5px; cursor:pointer; }
    input { padding:8px; margin:5px; width:90%; }
    .hidden { display:none; }
  </style>
</head>

<body>

<h2>SadiCoin (SDC) Platform</h2>

<!-- AUTH -->
<div id="authBox">
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="signUp()">Register</button>
  <button onclick="signIn()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <h3 id="userEmail"></h3>

  <button onclick="connectWallet()">Connect Wallet</button>
  <p id="walletAddress"></p>

  <hr>

  <h4>Buy SDC</h4>
  <button onclick="whatsappBuy('CASH')">Buy with Cash</button>
  <button onclick="whatsappBuy('ETF')">Buy with ETF</button>

  <hr>

  <h4>DEX Swap</h4>
  <button onclick="getQuote()">Get Swap Quote</button>
  <button onclick="executeSwap()">Execute Swap</button>

  <hr>

  <h4>Meetings / Camera Test</h4>
  <button onclick="testCamera()">Test Camera</button>
  <video id="cam" autoplay muted width="250"></video>

  <button onclick="logout()">Logout</button>
</div>

<script>
/* ===============================
   SUPABASE CONFIG
================================ */
const SUPABASE_URL = "https://jbhhfzbhcvzxtthhmfhz.supabase.co";
const SUPABASE_ANON_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiaGhmemJoY3Z6eHR0aGhtZmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzUxMDAsImV4cCI6MjA4MTA1MTEwMH0.86HR8bkhiNK4JjpDsIyAtu9l9x83UjlMG-mYGc_adJc";

// âœ… THIS is the important line
const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

let currentUser = null;
let provider, signer, userWallet = null;
let lastQuote = null;

/* ===============================
   AUTH
================================ */
async function signUp() {
  const email = email.value;
  const password = password.value;

  const { data, error } = await supabase.auth.signUp({ email, password });
  if (error) return alert(error.message);

  await supabase.from("profiles").insert({
    id: data.user.id,
    email
  });

  alert("Registered successfully");
}

async function signIn() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({
    email, password
  });

  if (error) return alert(error.message);
  loadUserUI();
}

async function logout() {
  await supabase.auth.signOut();
  location.reload();
}

/* ===============================
   SESSION PERSISTENCE
================================ */
window.addEventListener("load", async () => {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) loadUserUI();
});

async function loadUserUI() {
  const { data: { user } } = await supabase.auth.getUser();
  currentUser = user;

  document.getElementById("authBox").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  document.getElementById("userEmail").innerText = user.email;

  await loadWallet();
}

/* ===============================
   WALLET
================================ */
async function connectWallet() {
  if (!window.ethereum) return alert("Install MetaMask");

  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  userWallet = await signer.getAddress();

  document.getElementById("walletAddress").innerText = userWallet;

  await supabase.from("wallets").upsert({
    user_id: currentUser.id,
    address: userWallet,
    chain: "polygon"
  });
}

async function loadWallet() {
  const { data } = await supabase
    .from("wallets")
    .select("*")
    .eq("user_id", currentUser.id)
    .single();

  if (data) {
    userWallet = data.address;
    document.getElementById("walletAddress").innerText = userWallet;
  }
}

/* ===============================
   WHATSAPP BUY (CASH / ETF)
================================ */
async function whatsappBuy(type) {
  await fetch("https://api.sacreserve.africa/api/whatsapp/buy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId: currentUser.id,
      email: currentUser.email,
      wallet: userWallet,
      type
    })
  });

  alert("WhatsApp request sent. Our desk will contact you.");
}

/* ===============================
   DEX AGGREGATOR (0x)
================================ */
async function getQuote() {
  if (!userWallet) return alert("Connect wallet first");

  const res = await fetch(
    `https://api.sacreserve.africa/api/swap/quote?fromToken=ETH&toToken=SDC&amount=1000000000000000000&userAddress=${userWallet}`
  );

  lastQuote = await res.json();
  alert("Quote received");
}

async function executeSwap() {
  if (!lastQuote) return alert("Get quote first");

  const tx = {
    to: lastQuote.to,
    data: lastQuote.data,
    value: lastQuote.value
  };

  await signer.sendTransaction(tx);
  alert("Swap submitted");
}

/* ===============================
   CAMERA / MEETINGS
================================ */
async function testCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true });
  document.getElementById("cam").srcObject = stream;
}
</script>

</body>
</html