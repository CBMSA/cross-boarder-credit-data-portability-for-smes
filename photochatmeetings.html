<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PhotoChat — Social • Payments • Crypto</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<!-- Supabase v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Ethers (optional wallet) -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<style>
body { background:#f7f8fb; padding:1.5rem; }
.chat-window { height:520px; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:12px; }
.message { margin-bottom:10px; }
.message.me { text-align:right; }
.bubble { display:inline-block; padding:8px 12px; border-radius:12px; max-width:78%; }
.message.me .bubble { background:#0d6efd; color:#fff; }
.message.them .bubble { background:#e9ecef; }
.panel { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:12px; }
.small-muted { font-size:.85rem; color:#6c757d; }
.video-preview { width:100%; max-height:210px; border-radius:8px; background:#000; }
</style>
</head>

<body>
<div class="container-fluid">

<!-- HEADER -->
<div class="d-flex align-items-center mb-3">
  <h3 class="mb-0">PhotoChat</h3>
  <div class="ms-auto small-muted">
    User ID: <strong id="userLabel">initializing…</strong>
  </div>
</div>

<div class="row g-3">

<!-- LEFT -->
<div class="col-md-3">
  <div class="panel mb-3">
    <h6>Wallet (optional)</h6>
    <div id="walletAddress">Not connected</div>
    <div id="walletBalance" class="small-muted">—</div>
    <button id="connectWalletBtn" class="btn btn-sm btn-outline-primary w-100 mt-2">
      <i class="bi bi-wallet2"></i> Connect Wallet
    </button>
  </div>

  <div class="panel">
    <h6>Contacts</h6>
    <div id="contactsList" class="small-muted">No contacts</div>
    <input id="addContactInput" class="form-control form-control-sm mt-2" placeholder="Paste User ID">
    <button id="addContactBtn" class="btn btn-sm btn-primary w-100 mt-2">Add</button>
  </div>
</div>

<!-- CENTER -->
<div class="col-md-6">
  <div class="panel">
    <h6 id="chatTitle">Chat</h6>

    <video id="localVideo" class="video-preview mb-2" autoplay muted></video>
    <button id="startMeetingBtn" class="btn btn-sm btn-outline-secondary mb-2">
      <i class="bi bi-camera-video"></i> Start Camera
    </button>

    <div id="chatWindow" class="chat-window">
      <div class="text-center small-muted">Select a contact</div>
    </div>

    <div class="d-flex gap-2 mt-2">
      <input id="messageInput" class="form-control" placeholder="Message">
      <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<!-- RIGHT -->
<div class="col-md-3">
  <div class="panel mb-3">
    <h6>Crypto Swap (Demo)</h6>
    <input id="swapAmount" class="form-control form-control-sm mb-2" placeholder="Amount">
    <button id="quoteBtn" class="btn btn-sm btn-outline-secondary w-100">Get Quote</button>
    <button id="swapBtn" class="btn btn-sm btn-success w-100 mt-2">Swap</button>
    <div id="swapResult" class="small-muted mt-2"></div>
  </div>

  <div class="panel">
    <h6>Ads</h6>
    <div id="adsArea" class="small-muted">No ads</div>
  </div>
</div>

</div>
</div>

<script>
/* =======================
   SUPABASE CONFIG
======================= */
const SUPABASE_URL = "https://jbhhfzbhcvzxtthhmfhz.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

const supabase = supabasejs.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

let currentUser = null;
let activeContact = null;

/* =======================
   INIT USER (NO LOGIN)
======================= */
async function initUser() {
  const { data:{ session } } = await supabase.auth.getSession();

  if (!session) {
    const { data, error } = await supabase.auth.signInAnonymously();
    if (error) return alert("Auth error");
    currentUser = data.user;
  } else {
    currentUser = session.user;
  }

  document.getElementById("userLabel").innerText =
    currentUser.id.slice(0,8);

  loadContacts();
}
window.addEventListener("DOMContentLoaded", initUser);

/* =======================
   WALLET (OPTIONAL)
======================= */
document.getElementById("connectWalletBtn").onclick = async () => {
  if (!window.ethereum) return alert("Wallet not installed");
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  const signer = provider.getSigner();
  const addr = await signer.getAddress();
  document.getElementById("walletAddress").innerText =
    addr.slice(0,6)+"..."+addr.slice(-4);
  const bal = await provider.getBalance(addr);
  document.getElementById("walletBalance").innerText =
    "ETH "+ethers.utils.formatEther(bal);
};

/* =======================
   CONTACTS
======================= */
async function loadContacts() {
  const { data } = await supabase
    .from("contacts")
    .select("*")
    .eq("owner", currentUser.id);

  const list = document.getElementById("contactsList");
  list.innerHTML = "";

  if (!data || !data.length) {
    list.innerHTML = "No contacts";
    return;
  }

  data.forEach(c => {
    const d = document.createElement("div");
    d.className = "border-bottom py-1";
    d.style.cursor = "pointer";
    d.innerText = c.contact.slice(0,8);
    d.onclick = () => openChat(c.contact);
    list.appendChild(d);
  });
}

document.getElementById("addContactBtn").onclick = async () => {
  const id = document.getElementById("addContactInput").value.trim();
  if (!id) return;
  await supabase.from("contacts").insert({
    owner: currentUser.id,
    contact: id
  });
  document.getElementById("addContactInput").value = "";
  loadContacts();
};

/* =======================
   CHAT
======================= */
function openChat(id) {
  activeContact = id;
  document.getElementById("chatTitle").innerText =
    "Chat with " + id.slice(0,8);
  loadMessages();
}

async function loadMessages() {
  const { data } = await supabase
    .from("messages")
    .select("*")
    .or(`sender.eq.${currentUser.id},receiver.eq.${currentUser.id}`)
    .order("created_at");

  const win = document.getElementById("chatWindow");
  win.innerHTML = "";

  data?.forEach(m => {
    if (![currentUser.id, activeContact].includes(m.sender) ||
        ![currentUser.id, activeContact].includes(m.receiver)) return;

    const div = document.createElement("div");
    div.className = "message " +
      (m.sender === currentUser.id ? "me":"them");
    div.innerHTML = `<div class="bubble">${m.content}</div>`;
    win.appendChild(div);
  });

  win.scrollTop = win.scrollHeight;
}

document.getElementById("sendBtn").onclick = async () => {
  if (!activeContact) return alert("Select contact");
  const msg = document.getElementById("messageInput").value.trim();
  if (!msg) return;
  document.getElementById("messageInput").value = "";
  await supabase.from("messages").insert({
    sender: currentUser.id,
    receiver: activeContact,
    content: msg
  });
  loadMessages();
};

/* =======================
   CAMERA
======================= */
document.getElementById("startMeetingBtn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  document.getElementById("localVideo").srcObject = stream;
};

/* =======================
   SWAP DEMO
======================= */
document.getElementById("quoteBtn").onclick = () =>
  document.getElementById("swapResult").innerText = "Quote received (demo)";
document.getElementById("swapBtn").onclick = () =>
  alert("DEX swap via api.sacreserve.africa (coming soon)");
</script>

</body>
</html>