<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PhotoChat</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  margin: 0;
  background: #fafafa;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  background: #fff;
  border-bottom: 1px solid #ddd;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  z-index: 10;
}
header h1 {
  font-size: 1.2rem;
  margin: 0;
}
header .icons {
  margin-left: auto;
  display: flex;
  gap: 16px;
  font-size: 1.3rem;
}

/* FEED */
.feed {
  max-width: 600px;
  margin: auto;
  padding-bottom: 90px;
}

/* POST */
.post {
  background: #fff;
  border-bottom: 1px solid #eee;
  margin-bottom: 12px;
}
.post-header {
  display: flex;
  align-items: center;
  padding: 10px;
}
.post-header img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin-right: 10px;
}
.post img.post-img {
  width: 100%;
  display: block;
}
.post-actions {
  display: flex;
  gap: 16px;
  padding: 10px;
  font-size: 1.4rem;
  cursor: pointer;
}
.post-caption {
  padding: 0 10px 10px;
  font-size: 0.9rem;
}

/* FLOAT BUTTON */
.fab {
  position: fixed;
  bottom: 80px;
  right: 20px;
  background: #ff3d00;
  color: white;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  cursor: pointer;
}

/* BOTTOM NAV */
nav {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
  font-size: 1.4rem;
}
</style>
</head>

<body>

<header>
  <h1>PhotoChat</h1>
  <div class="icons">
    <i class="bi bi-heart"></i>
    <i class="bi bi-chat"></i>
    <i class="bi bi-person-circle" onclick="login()"></i>
  </div>
</header>

<div class="feed" id="feed"></div>

<input type="file" id="fileInput" hidden />

<div class="fab" onclick="addPost()">+</div>

<nav>
  üè† üîç ‚ûï üí¨ üë§
</nav>

<script>
/* =========================
   SUPABASE (Vercel ENV)
========================= */

// ‚ö†Ô∏è These get replaced by Vercel at build time
const SUPABASE_URL = "NEXT_PUBLIC_SUPABASE_URL";
const SUPABASE_KEY = "NEXT_PUBLIC_SUPABASE_ANON_KEY";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   AUTH
========================= */
async function login() {
  const email = prompt("Enter your email");
  if (!email) return;

  await supabase.auth.signInWithOtp({ email });
  alert("Magic link sent to your email");
}

async function getUser() {
  const { data } = await supabase.auth.getUser();
  return data.user;
}

/* =========================
   LOAD POSTS
========================= */
async function loadPosts() {
  const { data } = await supabase
    .from("posts")
    .select("*, donations(amount)")
    .order("created_at", { ascending: false });

  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  (data || []).forEach(post => {
    const total = post.donations?.reduce((a,b)=>a+b.amount,0) || 0;

    feed.innerHTML += `
      <div class="post">
        <div class="post-header">
          <img src="https://i.pravatar.cc/36?u=${post.user_id}">
          <strong>user</strong>
        </div>
        <img src="${post.image_url}" class="post-img">
        <div class="post-actions">
          ‚ù§Ô∏è üí¨ üí∞
        </div>
        <div class="post-caption">
          <strong>${post.caption || ""}</strong><br>
          <small>üí∞ ${total} SDC donated</small>
        </div>
      </div>
    `;
  });
}

/* =========================
   ADD POST
========================= */
function addPost() {
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const user = await getUser();
  if (!user) {
    alert("Please login first");
    return;
  }

  const caption = prompt("Caption");

  const path = `${user.id}/${Date.now()}-${file.name}`;

  await supabase.storage.from("photos").upload(path, file);

  const imageUrl = `${SUPABASE_URL}/storage/v1/object/public/photos/${path}`;

  await supabase.from("posts").insert({
    user_id: user.id,
    caption,
    image_url: imageUrl
  });

  loadPosts();
});

/* =========================
   INIT
========================= */
loadPosts();
</script>

</body>
</html>