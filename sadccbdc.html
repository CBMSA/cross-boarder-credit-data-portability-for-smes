
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SadiCoin Wallet (Web3)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="container py-4">
  <h2 class="mb-3">üåç SadiCoin Web3 Wallet</h2>

  <button class="btn btn-primary mb-3" onclick="connectWallet()">Connect MetaMask</button>
  <p id="walletAddress" class="fw-bold text-success"></p>
  <p>Balance: <span id="balance">0</span> SADI</p>

  <div class="card p-3 mb-3">
    <h5>Send SadiCoin</h5>
    <input type="text" id="toAccount" class="form-control mb-2" placeholder="Recipient Wallet Address"/>
    <input type="number" id="amount" class="form-control mb-2" placeholder="Amount (SADI)"/>
    <button class="btn btn-dark w-100" onclick="sendTransaction()">Send</button>
    <div id="txResult" class="alert alert-info mt-3" style="display:none;"></div>
  </div>

  <div class="card p-3 mb-3">
    <h5>Transaction History</h5>
    <ul id="txHistory" class="list-group"></ul>
    <button class="btn btn-outline-secondary mt-3" onclick="generatePDF()">Download PDF Report</button>
  </div>

  <script>
    let web3;
    let contract;
    let accounts;
    let txHistory = [];

    // üìå Replace with your deployed contract address + ABI
    const contractAddress = "YOUR_DEPLOYED_CONTRACT_ADDRESS";
    const contractABI = [
      {
        "inputs": [{"internalType":"address","name":"_treasury","type":"address"}],
        "stateMutability":"nonpayable","type":"constructor"
      },
      {"anonymous":false,"inputs":[
        {"indexed":true,"internalType":"address","name":"from","type":"address"},
        {"indexed":true,"internalType":"address","name":"to","type":"address"},
        {"indexed":false,"internalType":"uint256","name":"taxAmount","type":"uint256"}
      ],"name":"TaxTaken","type":"event"},
      {"anonymous":false,"inputs":[
        {"indexed":true,"internalType":"address","name":"from","type":"address"},
        {"indexed":true,"internalType":"address","name":"to","type":"address"},
        {"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}
      ],"name":"Transfer","type":"event"},
      {"inputs":[{"internalType":"address","name":"account","type":"address"}],
        "name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],
        "stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"recipient","type":"address"},
        {"internalType":"uint256","name":"amount","type":"uint256"}],
        "name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],
        "stateMutability":"nonpayable","type":"function"},
      {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],
        "stateMutability":"view","type":"function"}
    ];

    // üîó Connect wallet
    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        accounts = await web3.eth.getAccounts();

        document.getElementById("walletAddress").innerText = "Connected: " + accounts[0];

        contract = new web3.eth.Contract(contractABI, contractAddress);
        updateBalance();
        listenToEvents();
      } else {
        alert("Install MetaMask to use this wallet.");
      }
    }

    // üìä Update balance
    async function updateBalance() {
      if (!contract || !accounts) return;
      const decimals = await contract.methods.decimals().call();
      const bal = await contract.methods.balanceOf(accounts[0]).call();
      document.getElementById("balance").innerText = (bal / (10 ** decimals)).toFixed(2);
    }

    // üí∏ Send tokens
    async function sendTransaction() {
      const to = document.getElementById("toAccount").value;
      const amount = document.getElementById("amount").value;
      if (!to || !amount) return alert("Enter recipient and amount.");

      const decimals = await contract.methods.decimals().call();
      const value = web3.utils.toBN(amount * (10 ** decimals));

      try {
        const tx = await contract.methods.transfer(to, value).send({ from: accounts[0] });
        const txId = tx.transactionHash;

        txHistory.push({ id: txId, to, amount, timestamp: new Date().toISOString() });
        document.getElementById("txResult").style.display = 'block';
        document.getElementById("txResult").innerText = `‚úÖ Tx Sent! Hash: ${txId}`;

        renderHistory();
        updateBalance();
      } catch (err) {
        console.error(err);
        alert("Transaction failed.");
      }
    }

    // üìú Listen to blockchain events
    function listenToEvents() {
      contract.events.Transfer({ fromBlock: "latest" })
        .on("data", event => {
          console.log("Event:", event);
          // Optional: auto-refresh history
        })
        .on("error", console.error);
    }

    // üìù Render history
    function renderHistory() {
      const list = document.getElementById("txHistory");
      list.innerHTML = "";
      txHistory.forEach(tx => {
        const item = document.createElement("li");
        item.className = "list-group-item";
        item.innerText = `${tx.timestamp} ‚Üí ${tx.to} : ${tx.amount} SADI (Tx: ${tx.id})`;
        list.appendChild(item);
      });
    }

    // üìÑ Generate PDF
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("SadiCoin Transaction History", 10, 10);
      txHistory.forEach((tx, i) => {
        doc.text(`${i + 1}. To: ${tx.to}, Amount: ${tx.amount} SADI, Tx: ${tx.id}`, 10, 20 + (i * 10));
      });
      doc.save("SadiCoin_Transactions.pdf");
    }
  </script>
</body>
</html>
