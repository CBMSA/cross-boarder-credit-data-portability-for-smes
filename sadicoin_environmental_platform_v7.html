<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>SadiCoin Tech ‚Äì NASA + GEE Environmental & Property Intelligence (Production)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff}
header{padding:12px;background:#11162a;text-align:center;font-weight:bold;font-size:1.1em}
#nasaMap,#geeMap{height:50vh;margin:5px 0}
.panel{padding:12px;background:#161c33;margin:6px;border-radius:6px}
button{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;margin:2px 0}
input,select,textarea{padding:5px;margin:2px 0}
.good{color:#4caf50}
.warn{color:#ff9800}
.bad{color:#f44336}
video,img{max-width:100%;border-radius:6px;margin-top:6px}
</style>
</head>
<body>

<header>üåç SadiCoin Tech ‚Äì NASA + GEE Environmental + Property Intelligence (Production)</header>

<!-- Toggle Maps -->
<div class="panel">
<button onclick="showNASA()">üåê NASA Global View</button>
<button onclick="showGEE()">üõ∞ GEE Property & Hazard View</button>
</div>

<!-- NASA Map -->
<div id="nasaMap"></div>

<!-- GEE Map -->
<div id="geeMap" style="display:none;"></div>

<!-- GEE Panels -->
<div id="geePanels" style="display:none">

  <!-- SEARCH & PROPERTY -->
  <div class="panel">
    <b>Search Community/Property (EE dataset)</b><br>
    <input type="text" id="searchBox" placeholder="Search city/state"/>
    <button onclick="searchEE()">üîç Search</button>
    <label>Confidence:</label>
    <select id="confidence"><option>Low</option><option>Medium</option><option>High</option></select>
  </div>

  <!-- PROPERTY VALUATION + FUNDING -->
  <div class="panel">
    <b>üè† Property Valuation + Disaster Funding Gap</b><br>
    <div id="propertyInfo">‚Ä¢ Select a property to calculate valuation based on Sentinel-1 / Sentinel-2 metrics.</div>
    <label>Previous Property Image:</label><br>
    <input type="file" accept="image/*" onchange="loadPreviousImage(event)"/>
    <img id="prevImage"/>
    <label>Current Property Image:</label><br>
    <input type="file" accept="image/*" onchange="loadCurrentImage(event)"/>
    <img id="currImage"/>
    <br>
    <button onclick="downloadPrevImage()">‚¨áÔ∏è Download Previous Image</button>
    <button onclick="downloadCurrImage()">‚¨áÔ∏è Download Current Image</button>
  </div>

  <!-- HAZARD TRENDS -->
  <div class="panel">
    <b>üìà Hazard Trends</b>
    <canvas id="trendChart" height="120"></canvas>
  </div>

  <!-- DAO / TRANSPARENCY -->
  <div class="panel">
    <b>üõ° DAO & Funding Transparency</b><br>
    <div id="daoPanel">
      ‚Ä¢ Municipality & Insurance scoring<br>
      ‚Ä¢ Disaster fund allocations (placeholder)
    </div>
  </div>

  <!-- COMBINED PDF REPORT -->
  <div class="panel">
    <b>üìÑ Download Combined PDF Report</b><br>
    <button onclick="exportCombinedPDF()">‚¨áÔ∏è Download Report</button>
  </div>

</div>

<script>
// ================== MAPS ==================
// NASA Map
const nasaMap = L.map('nasaMap').setView([0,0],2);
L.tileLayer(
 "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/2024-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
 {maxZoom:9, attribution:"NASA GIBS"}
).addTo(nasaMap);

// NASA EONET Events
fetch('https://eonet.gsfc.nasa.gov/api/v3/events?status=open')
  .then(res=>res.json())
  .then(data=>{
    data.events.forEach(event=>{
      event.geometry.forEach(geo=>{
        if(geo.type==="Point"){
          const [lng,lat]=geo.coordinates;
          L.circleMarker([lat,lng],{radius:5,color:"orange"})
            .addTo(nasaMap)
            .bindPopup(`<b>${event.title}</b><br>${event.categories[0].title}`);
        }
      });
    });
  });

// GEE Map
const geeMap = L.map('geeMap').setView([0,0],2);
let geeLayer = L.layerGroup().addTo(geeMap);
let searchLayer = L.layerGroup().addTo(geeMap);

// ================== TOGGLE ==================
function showNASA(){
  document.getElementById('nasaMap').style.display='block';
  document.getElementById('geeMap').style.display='none';
  document.getElementById('geePanels').style.display='none';
}
function showGEE(){
  document.getElementById('nasaMap').style.display='none';
  document.getElementById('geeMap').style.display='block';
  document.getElementById('geePanels').style.display='block';
}

// ================== SEARCH EE ==================
let selectedProperty=null;
async function searchEE(){
  const query=document.getElementById("searchBox").value;
  if(!query) return;
  try{
    const res=await fetch(`https://sadicoin-fa3d5.projects.earthengine.app/searchGeoJSON?query=${encodeURIComponent(query)}`);
    const data=await res.json();
    searchLayer.clearLayers();
    L.geoJSON(data,{
      style:{color:"green", fillOpacity:0.3},
      onEachFeature:(f,layer)=>{
        layer.bindPopup(f.properties.name||"Property");
        layer.on('click',()=>{selectedProperty=f;updatePropertyPanel();});
      }
    }).addTo(searchLayer);
    if(data.features.length>0){
      geeMap.fitBounds(L.geoJSON(data).getBounds());
    } else alert("No results found");
  }catch(e){console.error("EE search error",e);}
}

// ================== PROPERTY PANEL ==================
let prevImage=null, currImage=null;
async function updatePropertyPanel(){
  if(!selectedProperty) return;
  try {
    const geom = JSON.stringify(selectedProperty.geometry);
    // Replace this URL with your deployed GEE App endpoint
    const url = `https://sadicoin-fa3d5.projects.earthengine.app/getPropertyMetrics?geom=${encodeURIComponent(geom)}`;
    const res = await fetch(url);
    const data = await res.json();

    const baseValue = 1000000;
    const floodPixels = data.floodScore || 0;
    const firePixels = data.fireScore || 0;
    const ndviScore = data.ndviScore || 0;
    const hazardFactor = (floodPixels + firePixels + ndviScore/2).toFixed(1);
    const fundingGap = Math.round(baseValue * hazardFactor / 100);

    document.getElementById("propertyInfo").innerHTML=
      `<b>${selectedProperty.properties.name||"Property"}</b><br>
      Estimated Value: R${baseValue.toLocaleString()}<br>
      Flood Score: ${floodPixels.toFixed(2)}<br>
      Fire Score: ${firePixels.toFixed(2)}<br>
      NDVI Score: ${ndviScore.toFixed(2)}<br>
      Estimated Damage: R${fundingGap.toLocaleString()}<br>
      Hazard Factor: ${hazardFactor}%`;

  } catch(e){
    console.error("GEE metrics fetch error:", e);
    alert("Failed to fetch live satellite metrics.");
  }
}

function loadPreviousImage(e){const f=e.target.files[0];const r=new FileReader();r.onload=()=>{prevImage=r.result;document.getElementById("prevImage").src=prevImage;};r.readAsDataURL(f);}
function loadCurrentImage(e){const f=e.target.files[0];const r=new FileReader();r.onload=()=>{currImage=r.result;document.getElementById("currImage").src=currImage;};r.readAsDataURL(f);}
function downloadPrevImage(){if(prevImage){const a=document.createElement('a');a.href=prevImage;a.download="Previous_Property_Image.png";a.click();}}
function downloadCurrImage(){if(currImage){const a=document.createElement('a');a.href=currImage;a.download="Current_Property_Image.png";a.click();}}

// ================== HAZARD TRENDS ==================
const ctx=document.getElementById("trendChart").getContext("2d");
new Chart(ctx,{type:"line",data:{labels:["Jan","Feb","Mar","Apr","May","Jun"],datasets:[
  {label:"Floods",data:[4,6,9,7,10,12],borderColor:"blue"},
  {label:"Fires",data:[3,5,4,6,8,9],borderColor:"red"}
]}});

// ================== COMBINED PDF ==================
function exportCombinedPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.setFontSize(12);
  pdf.text("SadiCoin Tech ‚Äì Combined Report",10,10);

  if(selectedProperty){
    pdf.text("Property Report:",10,20);
    pdf.text(`Name: ${selectedProperty.properties.name||"Property"}`,10,27);
    pdf.text(document.getElementById("propertyInfo").innerText,10,34);
  }

  pdf.text("DAO & SAR Notes:",10,50);
  pdf.text("Funding Transparency & Anomaly Markers (placeholder)",10,57,{maxWidth:180});

  const chartCanvas=document.getElementById("trendChart");
  const chartImg=chartCanvas.toDataURL("image/png");
  pdf.addImage(chartImg,'PNG',10,70,180,80);

  let yPos=160;
  if(prevImage) pdf.addImage(prevImage,'PNG',10,yPos,80,60);
  if(currImage) pdf.addImage(currImage,'PNG',110,yPos,80,60);

  pdf.save("Combined_Report.pdf");
}
</script>
</body>
</html>