<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>SadiCoin Tech ‚Äì Environmental + SAR + Property Intelligence (V10)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b0f1a;color:#fff}
header{padding:12px;background:#11162a;text-align:center;font-weight:bold;font-size:1.1em}
#map{height:50vh;margin:5px 0}
.panel{padding:12px;background:#161c33;margin:6px;border-radius:6px}
button{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;margin:2px 0}
input,select,textarea{padding:5px;margin:2px 0}
.good{color:#4caf50}
.warn{color:#ff9800}
.bad{color:#f44336}
video,img{max-width:100%;border-radius:6px;margin-top:6px}
</style>
</head>

<body>

<header>üåç SadiCoin Tech ‚Äî Environmental + SAR + Property Intelligence (V10)</header>

<div id="controls" class="panel">
<b>Search Community/Property (EE dataset)</b><br>
<input type="text" id="searchBox" placeholder="Search city/state"/>
<button onclick="searchEE()">üîç Search</button>
<label>Confidence:</label>
<select id="confidence">
  <option>Low</option><option>Medium</option><option>High</option>
</select>
</div>

<div id="map"></div>

<div class="panel">
<b>üì° Satellite & Hazard Sources</b><br>
‚Ä¢ NASA GIBS (True Color)<br>
‚Ä¢ NASA EONET (Live disasters)<br>
‚Ä¢ Sentinel-1 SAR (Floods, terrain, landslides)<br>
‚Ä¢ Sentinel-2 (Fire, Drought, Vegetation)
</div>

<div class="panel">
<b>üÜò Search & Rescue ‚Äì Manual Scan</b><br>
<button onclick="startCamera()">üì∑ Start Camera Scan</button>
<button onclick="stopCamera()">‚èπ Stop</button><br>
<video id="camera" autoplay playsinline></video>
<hr>
<label><b>Upload Thermal / SAR Image</b></label><br>
<input type="file" accept="image/*" onchange="loadAnomaly(event)"/>
<img id="thermalPreview"/>
<br>
<button onclick="markAnomaly()">‚ö†Ô∏è Mark Possible Human Presence (Unverified)</button>
<p class="warn">‚ö†Ô∏è Markers indicate possible human presence only and require SAR review.</p>
</div>

<div class="panel">
<b>üìã SAR Review Workflow</b><br>
<textarea id="reviewNotes" placeholder="SAR reviewer notes‚Ä¶" style="width:100%;height:60px"></textarea><br>
<button onclick="exportSAR()">üìÑ Export SAR Brief (PDF)</button>
</div>

<div class="panel">
<b>üè† Property Valuation + Disaster Funding Gap</b><br>
<div id="propertyInfo">
‚Ä¢ Select a property to calculate valuation and estimated funding gap.
</div>
<label>Upload Previous Property Image:</label><br>
<input type="file" accept="image/*" onchange="loadPreviousImage(event)"/>
<img id="prevImage"/>
<label>Upload Current Property Image:</label><br>
<input type="file" accept="image/*" onchange="loadCurrentImage(event)"/>
<img id="currImage"/>
<br>
<button onclick="downloadPrevImage()">‚¨áÔ∏è Download Previous Image</button>
<button onclick="downloadCurrImage()">‚¨áÔ∏è Download Current Image</button>
</div>

<div class="panel">
<b>üìà Hazard Trends</b>
<canvas id="trendChart" height="120"></canvas>
</div>

<script>
// ================= MAP =================
const map = L.map('map').setView([0,0],2);

// Base: NASA GIBS True Color
L.tileLayer(
 "https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/2024-01-01/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg",
 {maxZoom:9, attribution:"NASA GIBS"}
).addTo(map);

// Layer groups
let geeLayer = L.layerGroup().addTo(map);
let sarLayer = L.layerGroup().addTo(map);
let searchLayer = L.layerGroup().addTo(map);

// ================= SEARCH EE =================
let selectedProperty = null;
async function searchEE(){
    const query=document.getElementById("searchBox").value;
    if(!query) return;
    try{
        const res=await fetch(`https://sadicoin-fa3d5.projects.earthengine.app/searchGeoJSON?query=${encodeURIComponent(query)}`);
        const data=await res.json();
        searchLayer.clearLayers();
        L.geoJSON(data,{
            style:{color:"green", fillOpacity:0.3},
            onEachFeature:(f,layer)=>{
                layer.bindPopup(f.properties.name||"Property");
                layer.on('click',()=>{
                    selectedProperty=f;
                    updatePropertyPanel();
                });
            }
        }).addTo(searchLayer);
        if(data.features.length>0){
            map.fitBounds(L.geoJSON(data).getBounds());
        } else alert("No results found");
    }catch(e){console.error("EE search error",e);}
}

// ================= CAMERA =================
let stream=null;
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:true});
    document.getElementById("camera").srcObject=stream;
  }catch(e){alert("Camera permission required");}
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());document.getElementById("camera").srcObject=null;}}

// ================= ANOMALY UPLOAD =================
let uploadedImage=null;
function loadAnomaly(e){
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=()=>{uploadedImage=reader.result;document.getElementById("thermalPreview").src=uploadedImage;};
  reader.readAsDataURL(file);
}

// ================= MARK ANOMALY =================
function markAnomaly(){
  map.once('click', e=>{
    const conf=document.getElementById("confidence").value;
    L.circleMarker(e.latlng,{radius:8,color: conf==="High"?"red":conf==="Medium"?"orange":"yellow"})
    .addTo(sarLayer)
    .bindPopup(`<b>Possible Human Presence (Unverified)</b><br>Confidence: ${conf}<br>Requires SAR confirmation`);
  });
  alert("Click on map to place unverified marker");
}

// ================= PDF EXPORT =================
function exportSAR(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("SadiCoin Tech ‚Äì SAR Review Brief",10,10);
  pdf.text("This report contains unverified anomaly markers.",10,20);
  pdf.text("Reviewer Notes:",10,35);
  pdf.text(document.getElementById("reviewNotes").value||"None",10,45,{maxWidth:180});
  pdf.save("SAR_Brief.pdf");
}

// ================= PROPERTY PANEL =================
let prevImage=null, currImage=null;

function updatePropertyPanel(){
  if(!selectedProperty) return;
  const baseValue=Math.floor(Math.random()*500000 + 50000); // Example valuation
  const hazardFactor=Math.floor(Math.random()*50); // Simulated hazard effect %
  const fundingGap=Math.round(baseValue*hazardFactor/100);
  document.getElementById("propertyInfo").innerHTML=
    `<b>${selectedProperty.properties.name||"Property"}</b><br>
    Estimated Value: R${baseValue.toLocaleString()}<br>
    Estimated Damage: R${fundingGap.toLocaleString()}<br>
    Hazard Factor: ${hazardFactor}%`;
}

function loadPreviousImage(e){const f=e.target.files[0];const r=new FileReader();r.onload=()=>{prevImage=r.result;document.getElementById("prevImage").src=prevImage;};r.readAsDataURL(f);}
function loadCurrentImage(e){const f=e.target.files[0];const r=new FileReader();r.onload=()=>{currImage=r.result;document.getElementById("currImage").src=currImage;};r.readAsDataURL(f);}
function downloadPrevImage(){if(prevImage){const a=document.createElement('a');a.href=prevImage;a.download="Previous_Property_Image.png";a.click();}}
function downloadCurrImage(){if(currImage){const a=document.createElement('a');a.href=currImage;a.download="Current_Property_Image.png";a.click();}}

// ================= TRENDS =================
const ctx=document.getElementById("trendChart").getContext("2d");
new Chart(ctx,{
  type:"line",
  data:{labels:["Jan","Feb","Mar","Apr","May","Jun"],datasets:[
    {label:"Floods",data:[4,6,9,7,10,12],borderColor:"blue"},
    {label:"Fires",data:[3,5,4,6,8,9],borderColor:"red"}
  ]}
});

// ================== GEE LIVE LAYERS ==================
async function loadGEELayer(type){
    try{
        const url=`https://sadicoin-fa3d5.projects.earthengine.app/getGeoJSON?type=${type}`;
        const res=await fetch(url);
        const data=await res.json();
        L.geoJSON(data,{
            style:{color:type==="floods"?"blue":type==="fires"?"red":"green",fillOpacity:0.3},
            onEachFeature:(f,layer)=>{
                if(type==="properties"){layer.on('click',()=>{selectedProperty=f;updatePropertyPanel();});}
            }
        }).addTo(geeLayer);
    }catch(e){console.error("GEE fetch error:",e);}
}

// Load layers on startup
loadGEELayer("floods");
loadGEELayer("fires");
loadGEELayer("properties");

</script>
</body>
</html>