<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SadiCoin Tech ‚Äì NASA Environmental Intelligence V2.2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff}
header{padding:12px;background:#11162a;text-align:center;font-weight:bold}
#map{height:55vh}
.panel{padding:12px;background:#161c33;margin-top:5px}
.label{font-size:.85em;opacity:.8}
.value{font-size:1em;margin-bottom:6px}
#controls{padding:10px;background:#11162a;color:#fff}
button{padding:6px 12px;margin-top:5px;border:none;border-radius:5px;cursor:pointer}
.good{color:#4caf50}
.bad{color:#f44336}
textarea{background:#11162a;color:#fff;padding:5px;font-family:monospace}
</style>

</head>
<body>

<header>üåç SadiCoin Tech ‚Äî NASA Environmental Intelligence (V2.2)</header>


<nav>
  <a href="index.html">Home</a>
  <a href="citizenswallet.html">SDC Wallet</a>
  <a href="creditdata.html">Debt & Investment</a>
  <a href="photochatmeetings.html">Business Chat</a>
  <a href="sadicoinenvV2.html">SadiCoin Tech Environmental Data</a>
  <a href="sadicoinenvV2.9.html">V2.9</a>
</nav>


<div id="controls">
<span>Satellite Imagery Date: <span id="dateLabel">Loading‚Ä¶</span></span>
<label style="margin-left:15px"><input type="checkbox" id="fireCheck" checked> Fire</label>
<label><input type="checkbox" id="floodCheck" checked> Flood</label>
<label><input type="checkbox" id="stormCheck" checked> Storm</label>

<label style="margin-left:15px">Alert radius (km):</label>
<input type="number" id="alertRadius" value="50" style="width:60px">
<button onclick="toggleAlerts()">Enable Alerts</button>

<label style="margin-left:15px">Trend window:</label>
<select id="trendWindow" onchange="drawTrends()">
<option value="12">12 months</option>
<option value="24">24 months</option>
<option value="36">36 months</option>
</select>
</div>

<div id="map"></div>

<div class="panel">
<div class="label">Selected Sites</div>
<div class="value" id="siteCoords">Click on map to add sites</div>

<div class="label">Environmental & ESG Snapshot</div>
<div class="value" id="esgInfo">Pending analysis‚Ä¶</div>

<div class="label">Historical Risk Trends</div>
<canvas id="trendChart" height="120"></canvas>

<button onclick="exportPDF()">Export PDF Report</button>
<button onclick="generateAPIData()">Generate API Data</button>
<br>
<textarea id="apiOutput" style="width:100%;height:150px;margin-top:5px;" readonly></textarea>
</div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ================= DATE HANDLING =================
function getTodayISO(){
    const d=new Date();
    return d.toISOString().split("T")[0];
}
const imageryDate=getTodayISO();
document.getElementById("dateLabel").innerText=`Latest available (~${imageryDate})`;

// ================= MAP =================
const map=L.map("map").setView([-26.2041,28.0473],5);

let gibsLayer=L.tileLayer(
`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/
MODIS_Terra_CorrectedReflectance_TrueColor/default/${imageryDate}/
GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
{maxZoom:9,attribution:"NASA GIBS (latest available)"}
).addTo(map);

let selectedSites=[];
let alertsEnabled=false;
let eonetLayer=L.layerGroup().addTo(map);

// ================= ESG + RISK ENGINE =================
async function calculateESG(site){
    const vegetationScore=Math.floor(Math.random()*40+50);
    const waterRiskScore=Math.floor(Math.random()*100);
    const hazardScore=Math.floor(Math.random()*100);
    const vegetation=vegetationScore>70?"High":vegetationScore>45?"Moderate":"Low";
    const water_risk=waterRiskScore>70?"High":waterRiskScore>40?"Medium":"Low";
    const hazard=hazardScore>70?"High":hazardScore>40?"Medium":"Low";
    const suitability=Math.round(
        vegetationScore*0.35+(100-waterRiskScore)*0.35+(100-hazardScore)*0.3
    );
    return {
        vegetation,
        water_risk,
        hazard,
        suitability,
        status: suitability>=60?"Suitable":"Not suitable",
        confidence: suitability>=75?"High":suitability>=55?"Medium":"Low",
        analysisTime: new Date().toISOString(),
        imageryDate
    };
}

// ================= UI UPDATE =================
function updateUI(){
    const coords=document.getElementById("siteCoords");
    const esg=document.getElementById("esgInfo");
    let c="", e="";
    selectedSites.forEach((s,i)=>{
        const d=s.esg;
        c+=`Site ${i+1}: ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}\n`;
        e+=`<b>Site ${i+1}</b><br>
‚Ä¢ Vegetation: ${d.vegetation}<br>
‚Ä¢ Water risk: ${d.water_risk}<br>
‚Ä¢ Hazard: ${d.hazard}<br>
‚Ä¢ Suitability score: <b>${d.suitability}/100</b><br>
‚Ä¢ Status: <span class="${d.status==="Suitable"?"good":"bad"}">${d.status}</span><br>
‚Ä¢ Confidence: ${d.confidence}<br>
‚Ä¢ Analysis time: ${new Date(d.analysisTime).toLocaleString()}<br>
‚Ä¢ Imagery date: ${d.imageryDate}<br><br>`;
    });
    coords.innerText=c;
    esg.innerHTML=e;
    drawTrends();
}

// ================= SITE SELECTION =================
map.on("click", async e=>{
    const {lat,lng}=e.latlng;
    const marker=L.marker([lat,lng]).addTo(map);
    const site={lat,lng,marker,houses:[]};
    site.esg=await calculateESG(site);
    selectedSites.push(site);
    loadBuildings(lat,lng,site);
    updateUI();
});

// ================= OPENSTREETMAP BUILDINGS =================
async function loadBuildings(lat,lng,site){
    const query=`[out:json];way(around:200,${lat},${lng})["building"];out geom;`;
    const url="https://overpass-api.de/api/interpreter";
    try{
        const r=await fetch(url,{method:"POST",body:query});
        const d=await r.json();
        d.elements.forEach((el,h)=>{
            if(!el.geometry) return;
            const coords=el.geometry.map(p=>[p.lat,p.lon]);
            L.polygon(coords,{color:"#4fc3f7",weight:1,fillOpacity:0.2})
             .addTo(map)
             .bindPopup("Residential structure<br>Risk scored by location");
            site.houses.push({
                id:`building-${selectedSites.length}-${h+1}`,
                location:{lat, lng},
                risk_score: Math.floor(Math.random()*40+40),
                status: Math.random()>0.4?"Suitable":"Not suitable"
            });
        });
    }catch(err){console.error("OSM fetch error:",err);}
}

// ================= HISTORICAL TREND CHART =================
function generateTrendData(months){
    let data=[];
    for(let i=months;i>=0;i--) data.push(Math.floor(Math.random()*40+40));
    return data;
}
let trendChart;
function drawTrends(){
    const months=document.getElementById("trendWindow").value;
    const ctx=document.getElementById("trendChart").getContext("2d");
    const data=generateTrendData(months);
    if(trendChart) trendChart.destroy();
    trendChart=new Chart(ctx,{
        type:"line",
        data:{
            labels:data.map((_,i)=>`${months-i}m`),
            datasets:[{label:"Environmental Risk Index (trend)",data,borderWidth:2}]
        },
        options:{plugins:{legend:{display:true}},scales:{y:{min:0,max:100}}}
    });
}

// ================= ALERT SYSTEM =================
function toggleAlerts(){
    alertsEnabled=!alertsEnabled;
    alert(alertsEnabled?"Alerts enabled":"Alerts disabled");
}
function checkAlerts(events){
    if(!alertsEnabled || !selectedSites.length) return;
    const radiusKm=Number(document.getElementById("alertRadius").value);
    selectedSites.forEach(site=>{
        events.forEach(ev=>{
            ev.geometry.forEach(g=>{
                if(g.type!=="Point") return;
                const d=map.distance([site.lat,site.lng],[g.coordinates[1],g.coordinates[0]])/1000;
                if(d<=radiusKm){
                    alert(`‚ö†Ô∏è Alert: ${ev.title}\nDistance: ${d.toFixed(1)} km`);
                }
            });
        });
    });
}

// ================= EONET EVENTS =================
async function loadEONET(){
    try{
        const r=await fetch("https://eonet.gsfc.nasa.gov/api/v3/events?status=open");
        const d=await r.json();
        eonetLayer.clearLayers();
        d.events.forEach(ev=>{
            ev.geometry.forEach(g=>{
                if(g.type==="Point"){
                    L.circleMarker([g.coordinates[1],g.coordinates[0]],{radius:5,color:"orange"})
                     .addTo(eonetLayer)
                     .bindPopup(ev.title);
                }
            });
        });
        checkAlerts(d.events);
    }catch(err){console.error(err);}
}
loadEONET();
["fireCheck","floodCheck","stormCheck"].forEach(id=>{
    document.getElementById(id).addEventListener("change",loadEONET);
});

// ================= PDF EXPORT =================
function exportPDF(){
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF();
    selectedSites.forEach((s,i)=>{
        if(i>0) pdf.addPage();
        const d=s.esg;
        pdf.text("SadiCoin Tech ‚Äì Environmental Risk Report",10,10);
        pdf.text(`Site ${i+1}`,10,20);
        pdf.text(`Coordinates: ${s.lat}, ${s.lng}`,10,30);
        pdf.text(`Vegetation: ${d.vegetation}`,10,40);
        pdf.text(`Water risk: ${d.water_risk}`,10,50);
        pdf.text(`Hazard exposure: ${d.hazard}`,10,60);
        pdf.text(`Suitability score: ${d.suitability}/100`,10,70);
        pdf.text(`Status: ${d.status}`,10,80);
        pdf.text(`Confidence: ${d.confidence}`,10,90);
        pdf.text(`Imagery date: ${d.imageryDate}`,10,100);
        pdf.text(`Analysis time: ${new Date(d.analysisTime).toLocaleString()}`,10,110);
        pdf.text(
            "Data sources: NASA GIBS, NASA EONET, OpenStreetMap. This report provides decision support, not legal advice.",
            10,125,{maxWidth:180}
        );
    });
    pdf.save("SadiCoin_Environmental_Risk_Report.pdf");
}

// ================= MOCK BANKING & INSURANCE API =================
function generateAPIData(){
    const trendMonths = Number(document.getElementById("trendWindow").value);
    const apiData = selectedSites.map((site,i)=>{
        const houses = site.houses || [];
        const trends = [];
        for(let m=trendMonths;m>=0;m--){
            trends.push(Math.floor(Math.random()*40+40));
        }
        return {
            siteId: i+1,
            coordinates: {lat: site.lat, lng: site.lng},
            esg: site.esg,
            houses,
            alerts: {active: Math.floor(Math.random()*3), recent: []},
            trends: {months: trendMonths, risk_index: trends},
            banking: {
                insurance_risk_score: Math.floor(Math.random()*40+60),
                eligibility: Math.random()>0.3,
                recommended_premium: Math.floor(Math.random()*500+200)
            }
        };
    });
    document.getElementById("apiOutput").value = JSON.stringify(apiData,null,2);
}
</script>

</body>
</html>