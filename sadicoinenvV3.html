
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SadiCoin Tech ‚Äì NASA Environmental Intelligence V3</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:#fff;}
header{padding:12px;background:#11162a;text-align:center;font-weight:bold;}
#map{height:55vh;}
.panel{padding:12px;background:#161c33;margin-top:5px;}
.label{font-size:.85em;opacity:.8;}
.value{font-size:1em;margin-bottom:6px;}
#controls{padding:10px;background:#11162a;color:#fff;}
button{padding:6px 12px;margin-top:5px;border:none;border-radius:5px;cursor:pointer;}
.good{color:#4caf50;}
.bad{color:#f44336;}
.tabs{display:flex;cursor:pointer;margin-bottom:5px;}
.tab{flex:1;padding:8px;text-align:center;background:#22253b;}
.tab.active{background:#4caf50;color:#000;}
.tab-content{display:none;}
.tab-content.active{display:block;}
</style>
</head>
<body>

<header>üåç SadiCoin Tech ‚Äî NASA Environmental Intelligence (V1/V2/V3)</header>

<!-- Tabs -->
<div class="tabs">
<div class="tab active" data-tab="v1">V1</div>
<div class="tab" data-tab="v2">V2</div>
<div class="tab" data-tab="v3">V3</div>
</div>

<!-- Controls -->
<div id="controls">
<span>Satellite Imagery Date: <span id="dateLabel">Loading‚Ä¶</span></span>
<label style="margin-left:15px"><input type="checkbox" id="fireCheck" checked> Fire</label>
<label><input type="checkbox" id="floodCheck" checked> Flood</label>
<label><input type="checkbox" id="stormCheck" checked> Storm</label>
<label style="margin-left:15px">Alert radius (km):</label>
<input type="number" id="alertRadius" value="50" style="width:60px">
<button onclick="toggleAlerts()">Enable Alerts</button>
<label style="margin-left:15px">Trend window:</label>
<select id="trendWindow" onchange="drawTrends()">
<option value="12">12 months</option>
<option value="24">24 months</option>
<option value="36">36 months</option>
</select>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Tab Contents -->
<div class="tab-content active" id="v1">
<div class="panel">
<div class="label">V1 Selected Sites</div>
<div class="value" id="v1Coords">Click on map to add sites</div>
</div>
</div>

<div class="tab-content" id="v2">
<div class="panel">
<div class="label">V2 Selected Sites</div>
<div class="value" id="v2Coords">Click on map to add sites</div>

<div class="label">Environmental & ESG Snapshot</div>
<div class="value" id="v2Info">Pending analysis‚Ä¶</div>

<button onclick="exportPDF()">Export PDF Report</button>
</div>
</div>

<div class="tab-content" id="v3">
<div class="panel">
<div class="label">Historical Risk Trends</div>
<canvas id="trendChart" height="120"></canvas>
</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// =================== Tabs ===================
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// ================= DATE ===================
function getTodayISO(){return new Date().toISOString().split("T")[0];}
const imageryDate=getTodayISO();
document.getElementById("dateLabel").innerText=`Latest available (~${imageryDate})`;

// ================= MAP ===================
const map=L.map("map").setView([-26.2041,28.0473],5);
let gibsLayer=L.tileLayer(
`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${imageryDate}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
{maxZoom:9, attribution:"NASA GIBS (latest available)"}).addTo(map);

let selectedSites=[];
let alertsEnabled=false;
let eonetLayer=L.layerGroup().addTo(map);

// ================= ESG ENGINE ===================
async function calculateESG(site){
  const vegetationScore=Math.floor(Math.random()*40+50);
  const waterRiskScore=Math.floor(Math.random()*100);
  const hazardScore=Math.floor(Math.random()*100);
  const vegetation=vegetationScore>70?"High":vegetationScore>45?"Moderate":"Low";
  const water_risk=waterRiskScore>70?"High":waterRiskScore>40?"Medium":"Low";
  const hazard=hazardScore>70?"High":hazardScore>40?"Medium":"Low";
  const suitability=Math.round(vegetationScore*0.35+(100-waterRiskScore)*0.35+(100-hazardScore)*0.3);
  return{
    vegetation, water_risk, hazard, suitability,
    status:suitability>=60?"Suitable":"Not suitable",
    confidence:suitability>=75?"High":suitability>=55?"Medium":"Low",
    analysisTime:new Date().toISOString(),
    imageryDate
  };
}

// ================= UI UPDATE ===================
function updateUI(){
  // V1
  const v1Div=document.getElementById("v1Coords");
  let v1Text="";
  selectedSites.forEach((s,i)=>{v1Text+=`Site ${i+1}: ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}\n`;});
  v1Div.innerText=v1Text||"Click on map to add sites";

  // V2
  const v2Div=document.getElementById("v2Coords");
  const v2Info=document.getElementById("v2Info");
  let v2Text="", v2InfoText="";
  selectedSites.forEach((s,i)=>{
    const d=s.esg;
    v2Text+=`Site ${i+1}: ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}\n`;
    v2InfoText+=`<b>Site ${i+1}</b><br>
‚Ä¢ Vegetation: ${d.vegetation}<br>
‚Ä¢ Water risk: ${d.water_risk}<br>
‚Ä¢ Hazard: ${d.hazard}<br>
‚Ä¢ Suitability score: <b>${d.suitability}/100</b><br>
‚Ä¢ Status: <span class="${d.status==="Suitable"?"good":"bad"}">${d.status}</span><br>
‚Ä¢ Confidence: ${d.confidence}<br>
‚Ä¢ Imagery date: ${d.imageryDate}<br>
‚Ä¢ Analysis time: ${new Date(d.analysisTime).toLocaleString()}<br><br>`;
  });
  v2Div.innerText=v2Text||"Click on map to add sites";
  v2Info.innerHTML=v2InfoText||"Pending analysis‚Ä¶";

  // V3 trend chart
  drawTrends();
}

// ================= SITE SELECTION ===================
map.on("click",async e=>{
  const {lat,lng}=e.latlng;
  const marker=L.marker([lat,lng]).addTo(map);
  const site={lat,lng,marker};
  site.esg=await calculateESG(site);
  selectedSites.push(site);
  updateUI();
  loadBuildings(lat,lng);
});

// ================= OPENSTREETMAP BUILDINGS ===================
async function loadBuildings(lat,lng){
  const query=`[out:json];way(around:200,${lat},${lng})["building"];out geom;`;
  try{
    const r=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:query});
    const d=await r.json();
    d.elements.forEach(el=>{
      if(!el.geometry) return;
      const coords=el.geometry.map(p=>[p.lat,p.lon]);
      L.polygon(coords,{color:"#4fc3f7",weight:1,fillOpacity:0.2})
       .addTo(map)
       .bindPopup("Residential structure<br>Risk scored by location");
    });
  }catch(err){console.error(err);}
}

// ================= HISTORICAL TREND CHART ===================
function generateTrendData(months){let data=[];for(let i=months;i>=0;i--) data.push(Math.floor(Math.random()*40+40)); return data;}
let trendChart;
function drawTrends(){
  const months=document.getElementById("trendWindow").value;
  const ctx=document.getElementById("trendChart").getContext("2d");
  const data=generateTrendData(months);
  if(trendChart) trendChart.destroy();
  trendChart=new Chart(ctx,{
    type:"line",
    data:{labels:data.map((_,i)=>`${months-i}m`),datasets:[{label:"Environmental Risk Index (trend)",data,borderWidth:2}]},
    options:{plugins:{legend:{display:true}},scales:{y:{min:0,max:100}}}
  });
}
drawTrends();

// ================= ALERTS ===================
function toggleAlerts(){alertsEnabled=!alertsEnabled; alert(alertsEnabled?"Alerts enabled":"Alerts disabled");}
function checkAlerts(events){
  if(!alertsEnabled || !selectedSites.length) return;
  const radiusKm=Number(document.getElementById("alertRadius").value);
  selectedSites.forEach(site=>{
    events.forEach(ev=>{
      ev.geometry.forEach(g=>{
        if(g.type!=="Point") return;
        const d=map.distance([site.lat,site.lng],[g.coordinates[1],g.coordinates[0]])/1000;
        if(d<=radiusKm){
          alert(`‚ö†Ô∏è Alert: ${ev.title}\nDistance: ${d.toFixed(1)} km`);
        }
      });
    });
  });
}

// ================= EONET EVENTS ===================
async function loadEONET(){
  try{
    const r=await fetch("https://eonet.gsfc.nasa.gov/api/v3/events?status=open");
    const d=await r.json();
    eonetLayer.clearLayers();
    d.events.forEach(ev=>{
      ev.geometry.forEach(g=>{
        if(g.type==="Point") L.circleMarker([g.coordinates[1],g.coordinates[0]],{radius:5,color:"orange"}).addTo(eonetLayer).bindPopup(ev.title);
    });
    checkAlerts(d.events);
  }catch(err){console.error(err);}
}
loadEONET();
["fireCheck","floodCheck","stormCheck"].forEach(id=>{document.getElementById(id).addEventListener("change",loadEONET);});

// ================= PDF EXPORT ===================
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  selectedSites.forEach((s,i)=>{
    if(i>0) pdf.addPage();
    const d=s.esg;
    pdf.text("SadiCoin Tech ‚Äì Environmental Risk Report",10,10);
    pdf.text(`Site ${i+1}`,10,20);
    pdf.text(`Coordinates: ${s.lat}, ${s.lng}`,10,30);
    pdf.text(`Vegetation: ${d.vegetation}`,10,40);
    pdf.text(`Water risk: ${d.water_risk}`,10,50);
    pdf.text(`Hazard exposure: ${d.hazard}`,10,60);
    pdf.text(`Suitability score: ${d.suitability}/100`,10,70);
    pdf.text(`Status: ${d.status}`,10,80);
    pdf.text(`Confidence: ${d.confidence}`,10,90);
    pdf.text(`Imagery date: ${d.imageryDate}`,10,100);
    pdf.text(`Analysis time: ${new Date(d.analysisTime).toLocaleString()}`,10,110);
    pdf.text("Data sources: NASA GIBS, NASA EONET, OpenStreetMap. Decision support only.",10,125,{maxWidth:180});
  });
}
</script>

</body>
</html>